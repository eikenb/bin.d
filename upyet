#!/bin/sh

# XXX  change to use fping

# kavi - 66.179.20.222
# google - 64.233.187.99
# isp nameserver - 
#   primary 24.197.160.17
#   secondary 24.197.160.18
#
#IP=68.180.206.184 # yahoo
IP=69.147.122.70 # yahoo
AIP=74.125.65.104 # google
GIP=68.118.117.233
VPSIP=68.68.99.138

flip=
ping=
count=1
interval=1
timeout=2
cmd=`basename $0`
delay=2

usage () {
    echo "usage: $cmd [options] [IP]"
    echo "-i ping interval"
    echo "-s sleep delay"
    if [ "$cmd" = "upyet" ]; then
        echo "-p ping"
        echo "-c N count N times"
    else
        echo '-t response timeout'
        echo '-f flip to upyet when down'
    fi
    echo "-a alternate IP"
    echo "-g ISP gateway"
    echo "-v my vps at prgmr.com"
    exit 0
}

while getopts avfghpi:c:t:s: arg; do
    case $arg in
        p) ping=true; [ $count -eq 1 ] && count= ; shift;;
        c) count=$OPTARG; shift; shift;;
        i) interval=$OPTARG; shift; shift;;
        a) IP=$AIP; shift;;
        v) IP=$VPSIP; shift;;
        f) flip=true; shift;;
        g) IP=$GIP; shift;;
        t|w) timeout=$OPTARG; shift; shift;;
        s|d) delay=$OPTARG; shift; shift;;
        h) usage;;
    esac
done

# non-flagged arg is IP/host
[ -n "$1" ] && IP=$1

HL="\033[0;31m"
RST="\033[0m"

if [ "$cmd" = "downyet" ]; then
    # try this sometime. curious if -W works.
    #/bin/ping -W $timeout -i $interval $IP
    date;
    until ! /bin/ping -W $timeout -c $count $IP; do
        sleep $delay;
        date;
    done
    if [ -n "$flip" ]; then
        /usr/bin/play -q ~/.themes/sounds/thunder.wav &
        echo "${HL}-------------------- DOWN --------------------${RST}"
        exec upyet;
    else
        exec /usr/bin/play -q ~/.themes/sounds/thunder.wav;
    fi
else
    if [ -n "$ping" ] ; then
        if [ -n "$count" ]; then
            echo /bin/ping -i $interval -c $count $IP
            /bin/ping -i $interval -c $count $IP
        else
            /bin/ping -i $interval $IP
        fi
    else
        date;
        until /bin/ping -i $interval -q -c $count $IP; do
            sleep $delay;
            date;
        done
        exec /usr/bin/play -q ~/.themes/sounds/itsawak2.wav;
    fi
fi

#/usr/bin/aplay /usr/local/share/sounds/hamster.au;
## vim: expandtab
